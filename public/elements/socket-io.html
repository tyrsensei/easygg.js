<link rel="import" href="/assets/polymer/polymer.html">

<script src="/socket.io/socket.io.js"></script>

<dom-module id="socket-io">
    <template>
        <content></content>
    </template>

    <script>
        var namespaces = {};
        var current_socket;

        Polymer({
            is: 'socket-io',
            properties: {
                namespace: String,
                emit: String,
                emitData: Object,
                interval: Number,
                targetElement: String,
                targetEvent: String,
                receive: String,
                receiveCallback: String
            },
            ready: function() {
            },
            attached: function() {
                if (this.emit) {
                    // Emit a message
                    var message = this.emit;
                    var namespace = this.namespace;
                    var data = this.emitData;

                    var emitMessage = function(){
                        var socket = current_socket;
                        if (namespace) {
                            socket = this.changeNamespace(namespace);
                        }
                        if (data) {
                            socket.emit(message, data);
                        } else {
                            socket.emit(message);
                        }
                    }.bind(this);

                    if (this.targetEvent) {
                        // if an event is defined, prepare the emit action
                        this.queryEffectiveChildren(this.targetElement).addEventListener(this.targetEvent, emitMessage);
                    } else {
                        if (this.interval) {
                            setInterval(emitMessage, this.interval);
                        }
                        // if no event, send the message already
                        emitMessage();
                    }
                } else if (this.receive) {
                    // Message received
                    var socket = current_socket;
                    if (this.namespace) {
                        socket = this.changeNamespace(this.namespace);
                    }
                    socket.on(this.receive, window[this.receiveCallback]);
                } else if (this.namespace) {
                    // Set a namespace
                    current_socket = this.changeNamespace(this.namespace);
                }
            },
            changeNamespace: function(namespace) {
                // change the namespace used
                var ns;
                if (typeof window[namespace] === "function") {
                    ns = window[namespace]();
                } else {
                    ns = namespace;
                }
                if (ns == "") {
                    ns = '/';
                }
                if (!namespaces[ns]) {
                    namespaces[ns] = io(ns);
                }

                return namespaces[ns];
            }

        });
    </script>
</dom-module>
